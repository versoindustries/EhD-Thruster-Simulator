# Enhanced EHD Physics Simulation Module (`physix_single.py`)

This module simulates **Enhanced Electrohydrodynamics (EHD)** physics, integrating pressure correction, Townsend ionization, and material property hooks. It leverages **TensorFlow** for GPU-accelerated computations, making it suitable for high-performance simulations of EHD devices such as ionic thrusters. The code models the interactions between electrostatics, ionization processes, and fluid dynamics in a 3D domain.

## Overview

The `physix_single.py` script is a self-contained simulation tool that computes the thrust generated by an EHD device. It solves a coupled system of equations including:

- **Poisson Equation** for electric potential.
- **Transport Equations** for electron and ion densities.
- **Navier-Stokes Equations** for fluid flow with an electric body force.

Key features include:
- **Non-uniform 3D grid** with stretching for enhanced resolution near electrodes.
- **Multigrid solver** for efficient Poisson equation solutions.
- **WENO5 scheme** for stable advection in transport and fluid solvers.
- **GPU acceleration** via TensorFlow.

## Physical Constants and Parameters

The module defines fundamental physical constants and simulation parameters as TensorFlow constants for GPU compatibility:

- **Permittivity of Free Space (`EPSILON_0`)**: `8.854e-12 F/m` - Used in electrostatic calculations.
- **Air Density (`RHO_AIR`)**: `1.225 kg/m³` - Base density at sea level, adjusted with altitude.
- **Ion Mobility (`MU_ION`)**: `2e-4 m²/V·s` - Governs ion movement in electric fields.
- **Electron Mobility (`MU_E`)**: `0.04 m²/V·s` - Governs electron movement.
- **Corona Onset Field Strength (`E_ONSET_DEFAULT`)**: `3e6 V/m` - Threshold for ionization.
- **Townsend Coefficients**:
  - `TOWNSEND_A_DEFAULT`: `15 cm⁻¹ torr⁻¹` - First Townsend coefficient.
  - `TOWNSEND_B_DEFAULT`: `365 V cm⁻¹ torr⁻¹` - Second Townsend coefficient.

These constants are used in equations like the Poisson equation and ionization models.

## Key Components

### 1. Grid and Electrode Setup

#### Grid Generation
The `setup_grid_tf` function creates a **non-uniform 3D grid** using hyperbolic tangent stretching to cluster points near electrodes:

- **Inputs**: Emitter radius (`r_e`), collector radius (`r_c`), gap distance (`d`), emitter length (`l`), base grid sizes (`nx_base`, `ny_base`, `nz_base`).
- **Method**: 
  - Stretches coordinates using `stretched_linspace` with `tanh` functions.
  - Ensures grid sizes are powers of 2 for multigrid efficiency.
  - Caps total elements to manage memory (default `5e6`).
- **Output**: 1D coordinate tensors (`x`, `y`, `z`) and grid dimensions (`nx`, `ny`, `nz`).

#### Electrode Definition
The `define_electrodes_tf` function sets up electrode boundaries and initial potential:

- **Geometry**: Supports `cylindrical`, `pointed`, and `hexagonal` emitter shapes.
- **Boundary Conditions**: 
  - Emitter at applied voltage (`V`).
  - Collector at 0 V.
- **Mathematics**: Uses geometric criteria with tolerances (e.g., `xy_tolerance = max(min_dx * 3, r_e * 0.2)`) to define masks.
- **Output**: Potential field (`phi`), boundary mask, collector mask, status code.

### 2. Multigrid Solver for Poisson Equation

The `multigrid_v_cycle_tf` function solves **∇²φ = -ρ/ε₀** (Poisson equation) efficiently:

- **Equation**: 
  \[
  \nabla^2 \phi = -\frac{\rho}{\varepsilon_0}
  \]
  where `φ` is electric potential, `ρ` is charge density, and `ε₀` is permittivity.

- **Method**: 
  - **Red-Black Gauss-Seidel Smoother**: Iteratively smooths the solution.
  - **Restriction**: Transfers residuals to coarser grids via averaging.
  - **Prolongation**: Interpolates corrections back to finer grids.
  - **V-Cycle**: Combines smoothing, restriction, and prolongation over multiple grid levels.

- **Implementation**: Uses precomputed Laplacian coefficients for non-uniform grids.

### 3. Transport Solvers

#### Electron Transport
The `solve_electron_transport_tf` function solves:

\[
\frac{\partial n_e}{\partial t} + \nabla \cdot (n_e \mathbf{v}_e) = D_e \nabla^2 n_e + S_e - \beta n_e n_i
\]

- **Terms**:
  - \( n_e \): Electron density.
  - \( \mathbf{v}_e = -\mu_e \mathbf{E} \): Drift velocity.
  - \( D_e \): Diffusion coefficient (`0.1 m²/s`).
  - \( S_e \): Source term from ionization.
  - \( \beta \): Recombination coefficient (`1.6e-13 m³/s`).

- **Method**: Semi-implicit scheme with WENO5 advection and Jacobi iterations for diffusion.

#### Ion Transport
The `solve_ion_transport_tf` function solves:

\[
\frac{\partial n_i}{\partial t} + \nabla \cdot (n_i (\mathbf{u} + \mu_i \mathbf{E})) = D_i \nabla^2 n_i + S_i - \beta n_e n_i
\]

- **Terms**:
  - \( n_i \): Ion density.
  - \( \mathbf{u} \): Fluid velocity.
  - \( \mu_i \): Ion mobility (`1.4e-4 m²/V·s`).
  - \( D_i \): Diffusion coefficient (`3e-6 m²/s`).

- **Method**: Similar to electron transport, with combined fluid and drift velocities.

### 4. Navier-Stokes Solver

The `solve_navier_stokes_projection_tf` function solves the incompressible Navier-Stokes equations with an electric body force:

- **Equations**:
  - **Continuity**: \(\nabla \cdot \mathbf{u} = 0\)
  - **Momentum**: 
    \[
    \frac{\partial \mathbf{u}}{\partial t} + (\mathbf{u} \cdot \nabla) \mathbf{u} = -\frac{\nabla p}{\rho} + \nu \nabla^2 \mathbf{u} + \frac{\rho_e \mathbf{E}}{\rho}
    \]
    where \( \mathbf{u} \) is velocity, \( p \) is pressure, \( \nu = \mu/\rho \) is kinematic viscosity, and \( \rho_e \mathbf{E} \) is the electric force.

- **Method**: 
  - **Projection Method**: Predicts intermediate velocity, then corrects with pressure.
  - **Advection**: WENO5 scheme for stability.
  - **Pressure Poisson**: Solved via multigrid (`multigrid_v_cycle_tf`).

### 5. Coupling Physics

The `couple_physics_tf_core` function integrates all physics:

- **Loop**:
  1. Solve Poisson equation for `φ`.
  2. Compute electric field \(\mathbf{E} = -\nabla \phi\).
  3. Update \( n_e \) and \( n_i \) via transport solvers.
  4. Compute charge density \(\rho = e (n_i - n_e)\).
  5. Solve Navier-Stokes for \(\mathbf{u}\) and \( p \).
  6. Check convergence based on changes in densities and velocity.

- **Convergence**: \(\Delta n_e, \Delta n_i, \Delta u < 10^{-3}\).

### 6. Thrust Calculation

The `calculate_thrust_tf` function computes thrust:

- **Formula**: 
  \[
  \mathbf{T} = \iiint_V \rho \mathbf{E} \, dV
  \]
  Scaled by air density ratio.

- **Implementation**: Uses TensorFlow reduction operations over the grid volume \( dV = dx \cdot dy \cdot dz \).

## Mathematical Foundations

### Poisson Equation
\[
\nabla^2 \phi = -\frac{\rho}{\varepsilon_0}
\]
Solved iteratively with multigrid to find `φ`, from which \(\mathbf{E} = -\nabla \phi\).

### Townsend Ionization
The ionization rate is modeled as:
\[
\alpha = p A \exp\left(-\frac{B p}{|E|}\right)
\]
Converted to SI units (m⁻¹) for source terms \( S_e = \alpha |\mathbf{v}_e| n_e \).

### Fluid Dynamics
The Navier-Stokes equations include an electric body force term \(\rho_e \mathbf{E}\), coupling electrostatics to fluid motion.

## Usage Example

```python
# Define parameters
params = (0.001, 0.01, 0.05, 0.02, 20000, 'cylindrical')  # r_e, r_c, d, l, V, shape
material_props = (15.0, 365.0, 3e6)  # townsend_A, townsend_B, E_onset
grid_settings = (32, 32, 64)  # nx_base, ny_base, nz_base
env_conditions = (1.0, 293.15, 0.0)  # pressure_atm, temperature_k, altitude_m
coupling_iters = 10

# Run simulation
Thrust_x, Thrust_y, Thrust_z, Thrust_Mag, status = simulate_thrust_tf(
    params, material_props, grid_settings, env_conditions, coupling_iters
)
print(f"Thrust: ({Thrust_x:.2f}, {Thrust_y:.2f}, {Thrust_z:.2f}) N, Magnitude: {Thrust_Mag:.2f} N")
```

## Requirements

- **TensorFlow 2.x** with GPU support.
- **NumPy**.
- **Python 3.10.11**.

## License

Copyright 2025 Verso Industries (Author: Michael B. Zimmerman)

Licensed under the Apache License, Version 2.0. See the [LICENSE](http://www.apache.org/licenses/LICENSE-2.0) file for details.